/*! principalfish 07-09-2017 */
function getData(a){$.when($.getJSON(a.mapurl,function(b){a.polygons=b}),$.getJSON(a.dataurl,function(b){a.seatData=b,currentMap=a})).then(function(){pageLoadEssentials()})}function pageLoadEssentials(){mapAttr.loadmap(currentMap),filters.opacities={},filters.reset(),choro.keyOnMap();var a=Object.keys(currentMap.seatData);a.sort(),$(function(){$("#searchseats").autocomplete({source:a,select:function(a,b){searchSeats(b.item.label)}})}),uiAttr.pageLoadDiv(),navigator.userAgent.toLowerCase().indexOf("firefox")>-1&&($("div").css("font-size","98%"),$("select").css("font-size","98%"))}function searchSeats(a){mapAttr.clicked(currentMap.seatData[a].mapSelect)}function pageSetting(a,b,c,d,e,f){this.name=a,this.mapurl=b,this.dataurl=c,this.previous=d,this.election=e,this.predict=f,this.seatData={},this.polygons={}}function initialization(){var a=brexit;uiAttr.changeNavBar(a.name),$(document).ready(function(){getData(a)})}var choro={keyOnMap:function(){$("#keyonmap").show();$("#keyonmap").append("<div class='leave'>Leave</div>");for(var a=5;a>0;a--){var b="rgba(0, 0, 255, "+.2*a+")",c="<div class='choro-minus' style='background-color: "+b+"'>"+(50+3*a).toFixed(1)+"%";5==a&&(c+="+"),c+="</div>",$("#keyonmap").append(c)}for(var a=0;a<6;a++){var b="rgba(255, 215, 0, "+.2*a+")",c="<div class='' style='background-color:"+b+"'>"+(50+3*a).toFixed(1)+"%";5==a&&(c+="+"),c+="</div>",$("#keyonmap").append(c)}$("#keyonmap").append("<div class='remain'>Remain</div>")}},partylist={};partylist.labour="Labour",partylist.conservative="Conservative",partylist.libdems="Lib Dems",partylist.snp="SNP",partylist.ukip="UKIP",partylist.plaidcymru="Plaid Cymru",partylist.green="Green",partylist.uu="UUP",partylist.sinnfein="Sinn FÃ©in",partylist.sdlp="SDLP",partylist.dup="DUP",partylist.alliance="Alliance",partylist.other="Other",partylist.others="Others",partylist.leave="Leave",partylist.remain="Remain";var regionlist={};regionlist.london="London",regionlist.southeastengland="S.E. England",regionlist.southwestengland="S. W. England",regionlist.westmidlands="W. Midlands",regionlist.northwestengland="N. W. England",regionlist.northeastengland="N. E. England",regionlist.yorkshireandthehumber="Yorks & Humber",regionlist.eastmidlands="E. Midlands",regionlist.eastofengland="E. England",regionlist.scotland="Scotland",regionlist.wales="Wales",regionlist.northernireland="N. Ireland",regionlist.unitedkingdom="United Kingdom",regionlist.greatbritain="Great Britain",regionlist.england="England";var regionMap={unitedkingdom:["northeastengland","northwestengland","yorkshireandthehumber","southeastengland","southwestengland","eastofengland","eastmidlands","westmidlands","london","scotland","wales","northernireland"],greatbritain:["northeastengland","northwestengland","yorkshireandthehumber","southeastengland","southwestengland","eastofengland","eastmidlands","westmidlands","london","scotland","wales"],england:["northeastengland","northwestengland","yorkshireandthehumber","southeastengland","southwestengland","eastofengland","eastmidlands","westmidlands","london"]},filters={state:{leave:[0,100]},selectHandle:function(a,b){a=a.substring(7),"null"==b?delete filters.state[a]:"region"==a&&"england"==b?filters.state.region=regionMap.england:filters.state[a]=b,filters.filter()},leave:function(a,b){"low"==a?filters.state.leave[0]=b:"high"==a&&(filters.state.leave[1]=b),filters.filter()},opacities:{},filter:function(){$.each(currentMap.seatData,function(a,b){var c=!0;if($.each(filters.state,function(a,d){if("leave"==a){var e=b.leave;(e<filters.state.leave[0]||e>filters.state.leave[1])&&(c=!1)}else"current"==a?b.current!=d&&(c=!1):d.indexOf(b[a])==-1&&(c=!1)}),1==c){var d=currentMap.seatData[a].current;filters.opacities[a]=20/3*(currentMap.seatData[a][d]/100-.5),b.filtered=!0}else filters.opacities[a]=0,b.filtered=!1}),filters.display()},display:function(){$.each(filters.opacities,function(a,b){var c=currentMap.seatData[a].mapSelect;c.opacity=b,d3.select("#i"+c.properties.info_id).attr("opacity",null),d3.select("#i"+c.properties.info_id).attr("fill-opacity",b),0==b&&d3.select("#i"+c.properties.info_id).attr("opacity",.02)}),filters.filteredList=[],$.each(currentMap.seatData,function(a,b){1==b.filtered&&(currentMap.seatData[a].name=a,filters.filteredList.push(currentMap.seatData[a]))}),$("#seatlist-sort"+voteTotals.activeSort).removeClass("sort-active"),voteTotals.activeSort="leave",$("#seatlist-sortleave").addClass("sort-active"),voteTotals.display(filters.filteredList)},reset:function(){filters.state={leave:[0,100]},$("#filter-current option:eq(0)").prop("selected",!0),$("#filter-winner2015 option:eq(0)").prop("selected",!0),$("#filter-region option:eq(0)").prop("selected",!0),$("#filter-leave").get(0).reset(),filters.filter()},filteredList:[]},mapAttr={width:600,height:875,active:d3.select(null),activeNode:null,clicked:function(a){mapAttr.activeNode=a,mapAttr.flashSeat(a);var b=path.bounds(a),c=Math.pow(b[1][0]-b[0][0],.5),d=Math.pow(b[1][1]-b[0][1],.5),e=(b[0][0]+b[1][0])/2,f=(b[0][1]+b[1][1])/2,g=.05/Math.max(c/mapAttr.width,d/mapAttr.height),h=[mapAttr.width/2-g*e,mapAttr.height/2-g*f];mapAttr.disableZoom(),svg.transition().duration(1500).call(zoom.transform,d3.zoomIdentity.translate(h[0],h[1]).scale(g)).on("end",mapAttr.enableZoom),uiAttr.showDiv("seat-information"),seatInfoTable.display(a.properties.name)},flashSeat:function(a){function b(){current.transition().duration(1500).attr("fill-opacity",.02).transition().duration(1500).attr("fill-opacity",a.opacity).on("end",b)}var c="#i"+a.properties.info_id;current=d3.select(c),b()},disableZoom:function(){svg.on("mousedown.zoom",null),svg.on("mousemove.zoom",null),svg.on("dblclick.zoom",null),svg.on("touchstart.zoom",null),svg.on("wheel.zoom",null),svg.on("mousewheel.zoom",null),svg.on("MozMousePixelScroll.zoom",null)},enableZoom:function(){svg.call(zoom)},reset:function(){null!=mapAttr.activeNode&&d3.select("#i"+mapAttr.activeNode.properties.info_id).transition().attr("fill-opacity",mapAttr.activeNode.opacity),mapAttr.activeNode=null,mapAttr.disableZoom(),svg.transition().duration(1500).call(zoom.transform,d3.zoomIdentity).on("end",function(){mapAttr.enableZoom()})},zoomed:function(){g.style("stroke-width",1.5/d3.event.scale+"px"),g.attr("transform",d3.event.transform)},stopped:function(){d3.event.defaultPrevented&&d3.event.stopPropagation()},loadmap:function(a){g.selectAll(".map").data(topojson.feature(a.polygons,a.polygons.objects.map).features).enter().append("path").attr("class",function(b){return b.properties.name in a.seatData?"mapdark "+a.seatData[b.properties.name].current:"map null"}).attr("fill-opacity",function(b){if(b.properties.name in currentMap.seatData){var c=a.seatData[b.properties.name].current,d=20/3*(a.seatData[b.properties.name][c]/100-.5);return a.seatData[b.properties.name].mapSelect=b,a.seatData[b.properties.name].mapSelect.opacity=d,d}return 0}).attr("id",function(a){return"i"+a.properties.info_id}).attr("d",path).on("click",mapAttr.clicked).append("svg:title").text(function(a){return a.properties.name}).each(function(b){b.properties.name in currentMap.seatData&&(a.seatData[b.properties.name].filtered=!0)}),g.append("path").datum(topojson.mesh(a.polygons,a.polygons.objects.map,function(a,b){return a.properties.region!=b.properties.region&&a!=b})).attr("d",path).attr("class","boundaries")}},projection=d3.geoAlbers().center([-.5,54.4]).rotate([2.25,0]).parallels([51,60]).scale(5300).translate([mapAttr.width/2,mapAttr.height/2]),path=d3.geoPath().projection(projection),zoom=d3.zoom().scaleExtent([1,8]).on("zoom",mapAttr.zoomed),currentMap,dataurls={map650:"650seat_no_ni.json",brexit:"houseofcommons/brexit.json"},brexit=new pageSetting("brexit",dataurls.map650,dataurls.brexit,dataurls.brexit,!1,!1),seatInfoTable={party:null,display:function(a){var b=currentMap.seatData[a],c=[{party:"remain",percent:b.remain},{party:"leave",percent:b.leave}];c.sort(function(a,b){return b.percent-a.percent}),seatInfoTable.seatInfo(a,b),seatInfoTable.voteTable(c),seatInfoTable.barChart(c)},seatInfo:function(a,b){$("#information-party .party-flair").removeClass(seatInfoTable.party),$("#information-seatname-span").text(a),$("#information-region").text(regionlist[b.region]),$("#information-party .party-name").text(partylist[b.winner2015]),$("#information-party .party-flair").addClass(b.winner2015),$("#information-majority").text(""),$("#information-turnout").text(""),seatInfoTable.party=b.winner2015},barChart:function(a){$("#information-bar").empty();var b=a.length,c={top:10,right:0,bottom:10,left:25},d=200-c.left-c.right,e=200-c.top-c.bottom,f=d3.min([90,d/b-2]),g=d3.select("#information-bar").append("svg").attr("width",d+c.left+c.right).attr("height",e+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")"),h=d3.scaleOrdinal().range([0,b*(f+2)]),i=d3.axisBottom().scale(h),j=d3.scaleLinear().range([e,0]),k=d3.axisLeft().scale(j).ticks(6),l=d3.max(a,function(a){return a.percent/1});j.domain([0,d3.max([60,l+(10-l%10)])]),g.append("g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(i),g.append("g").attr("class","y axis").call(k),g.selectAll("rect").data(a).enter().append("rect").attr("x",function(a,b){return 2*(b+1)+f*b}).attr("width",f).attr("y",e).attr("height",0).attr("class",function(a){return a.party}).transition().delay(function(a,b){return 250*b/2}).duration(250).attr("y",function(a){return j(a.percent)}).attr("height",function(a){return e-j(a.percent)})},voteTable:function(a){$("#information-chart").empty();for(var b=0;b<a.length;b++){var c="<div class='party-info-table'>";c+="<div class='party-flair "+a[b].party+"'></div>",c+="<div>"+partylist[a[b].party]+"</div>",c+="<div>"+a[b].percent.toFixed(2)+"%</div>",c+="</div>",$("#information-chart").append(c)}}},uiAttr={changeNavBar:function(a){$(".navbaractive").removeClass("navbaractive");var b="#nav-"+a;$(b).addClass("navbaractive");var c=$(b).text();$("#pagetitle").html(c),document.title=c},clickMapButton:function(a){var b=$(a).attr("class"),c=$(a).attr("id");b.indexOf("mapbuttonactive")==-1?($(a).addClass("mapbuttonactive"),uiAttr.showDiv(c)):uiAttr.hideDiv(c)},showDiv:function(a){uiAttr.zIndexCheck(a),$(uiAttr.buttonToDiv[a]).show(),$(uiAttr.buttonToDiv[a]).mousedown(function(){uiAttr.zIndexCheck(a),uiAttr.zIndexShuffle()}).draggable({handle:"h2",containment:"#wrapper"}),uiAttr.zIndexShuffle()},hideDiv:function(a){var b=uiAttr.zIndexTracker.indexOf(a);$("#"+a).removeClass("mapbuttonactive"),b!=-1&&uiAttr.zIndexTracker.splice(b,1),$(uiAttr.buttonToDiv[a]).hide(),uiAttr.zIndexShuffle()},buttonToDiv:{brexitvotesbutton:"#brexitvotes","seat-information":"#seat-information",votetotalsbutton:"#votetotals",filtersbutton:"#filters",choroplethsbutton:"#choropleths",seatlistbutton:"#seatlist","seatlist-extend":"#seatlist-extended",predictbutton:"#userinput","seat-600":"#seat-600"},zIndexTracker:[],zIndexCheck:function(a){if(uiAttr.zIndexTracker.indexOf(a)==-1)uiAttr.zIndexTracker.push(a);else{var b=uiAttr.zIndexTracker.indexOf(a),c=uiAttr.zIndexTracker.length-1;uiAttr.zIndexTracker.splice(b,1),uiAttr.zIndexTracker.splice(c,0,a)}},zIndexShuffle:function(){for(var a=uiAttr.zIndexTracker,b=0;b<a.length;b++)$(uiAttr.buttonToDiv[a[b]]).css("z-index",b+1)},pageLoadDiv:function(){$.each(uiAttr.buttonToDiv,function(a,b){"brexitvotesbutton"==a||"filtersbutton"==a?uiAttr.showDiv(a):"predictbutton"==a&&1==currentMap.predict?($("#predictbutton").removeClass("hidden").addClass("mapbuttonactive"),uiAttr.showDiv(a)):uiAttr.hideDiv(a)})}};voteTotals={display:function(a){voteTotals.sortState={name:"asc",region:"asc",leave:"desc",remain:"desc"},voteTotals.reorder("leave","desc")},activeSort:"leave",sortState:{},tableSort:function(a){a=a.slice(13),$("#seatlist-sort"+voteTotals.activeSort).removeClass("sort-active"),voteTotals.activeSort=a,$("#seatlist-sort"+voteTotals.activeSort).addClass("sort-active"),voteTotals.reorder(a,voteTotals.sortState[a]),"desc"==voteTotals.sortState[a]?voteTotals.sortState[a]="asc":"asc"==voteTotals.sortState[a]&&(voteTotals.sortState[a]="desc")},reorder:function(a,b){var c=filters.filteredList.map(function(a,b){return{ind:b,data:a}});"asc"==b&&c.sort(function(b,c){return b.data[a]<c.data[a]?-1:b.data[a]>c.data[a]?1:b.ind-c.ind}),"desc"==b&&c.sort(function(b,c){return b.data[a]<c.data[a]?1:b.data[a]>c.data[a]?-1:b.ind-c.ind}),filters.filteredList=c.map(function(a){return a.data}),voteTotals.extendedList()},seatTotals:function(){$("#brexitvotes-seatnumbers").empty();var a=filters.filteredList.length,b=0,c=0;$.each(filters.filteredList,function(a,d){"leave"==d.current?c+=1:b+=1});var d="<p style='font-weight: bold'>Total : "+a+" &nbsp;Remain <span class='party-flair remain'></span>: "+b+"&nbsp; Leave <span class='party-flair leave'></span>: "+c+"</p>";$("#brexitvotes-seatnumbers").append(d)},extendedList:function(){voteTotals.seatTotals(),$("#brexitvotes-data").empty(),$.each(filters.filteredList,function(a,b){var c=b.name,d="<div style='margin-left: 10px' class='party-flair "+b.current+"'></div>",e="<div style='margin-left: 10px'>"+regionlist[b.region]+"</div>",f="<div style='margin-left: 10px' class='party-flair "+b.winner2015+"'></div>",g="<div style='margin-left: 10px'>"+b.leave.toFixed(2)+"</div>",h="<div style='margin-left: 10px'>"+b.remain.toFixed(2)+"</div>",i="</div><div>",j="<div><div class='extended-seat' onclick='mapAttr.clicked(currentMap.seatData[\""+b.name+"\"].mapSelect)'>"+c+i+e+i+d+i+f+i+g+i+h+"</div></div>";$("#brexitvotes-data").append(j)})}};