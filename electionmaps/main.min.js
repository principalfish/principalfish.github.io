var battleground={active:!1,incumbent:"null",challenger:"null",region:"null",low:0,high:10,handle:function(t,e){"incumbent"==(t=t.substring(14))?battleground.incumbent=e:"challenger"==t?battleground.challenger=e:"region"==t?battleground.region="null"==e?"null":"england"==e?regionMap.england:[e]:"majlow"==t?isNaN(parseFloat(e))||(parseFloat(e)<0&&(e=0),battleground.low=parseFloat(e)):"majhigh"!=t||isNaN(parseFloat(e))||(100<parseFloat(e)&&(e=100),battleground.high=parseFloat(e)),battleground.check()},check:function(){"null"!=battleground.incumbent&&"null"!=battleground.challenger?(filters.reset(),battleground.incumbent!=battleground.challenger&&battleground.filter()):filters.reset()},filter:function(){var o;o="election2017"==currentMap.name?currentMap.seatData:currentMap.previousSeatData,$.each(currentMap.seatData,function(t,e){var a,n,r;o[t].seatInfo.current==battleground.incumbent&&(n=o[t].seatInfo.current,battleground.challenger in o[t].partyInfo)&&(n=o[t].partyInfo[n].total,r=o[t].partyInfo[battleground.challenger].total,a=o[t].seatInfo.turnout,battleground.low<=(n=100*(n/a-r/a)))&&n<=battleground.high?e.filtered=!0:e.filtered=!1,"null"!=battleground.region&&(r=o[t].seatInfo.region,-1==battleground.region.indexOf(r))&&(e.filtered=!1),0==e.filtered?filters.opacities[t]=.05:filters.opacities[t]=1}),filters.display()}},choro={choroTypes:["choro-voteshare","choro-votesharechange","swing"],handle:function(a,t){var e;$.each(choro.choroTypes,function(t,e){e!=a&&$("#"+e+" option:eq(0)").prop("selected",!0)}),a=a.slice(6),"null"!=t?(e=choro.minmax(a,t),choro.opacities(e,a,t),choro.applyClass(a,t),filters.changeSnpBorders(),filters.display(),choro.keyOnMap(e,a,t)):filters.filter()},minmax:function(r,o){var i=0;return $.each(currentMap.seatData,function(t,e){var a,n;1==e.filtered&&("voteshare"==r?o in e.partyInfo&&e.partyInfo[o].total/e.seatInfo.turnout>i&&(i=e.partyInfo[o].total/e.seatInfo.turnout):"votesharechange"==r&&(n=a=0,e=(a=o in e.partyInfo?e.partyInfo[o].total/e.seatInfo.turnout:a)-(n=o in currentMap.previousSeatData[t].partyInfo?currentMap.previousSeatData[t].partyInfo[o].total/currentMap.previousSeatData[t].seatInfo.turnout:n),Math.abs(e)>i)&&(i=Math.abs(e)))}),i=.6<i?.6:i},opacities:function(o,i,s){$.each(currentMap.seatData,function(t,e){var a,n,r=0;1==e.filtered&&0!=o&&("voteshare"==i?s in e.partyInfo&&(r=e.partyInfo[s].total/(e.seatInfo.turnout*o)):"votesharechange"==i&&(n=a=0,r=((a=s in e.partyInfo?e.partyInfo[s].total/e.seatInfo.turnout:a)-(n=s in currentMap.previousSeatData[t].partyInfo?currentMap.previousSeatData[t].partyInfo[s].total/currentMap.previousSeatData[t].seatInfo.turnout:n))/o)),filters.opacities[t]=r=1<r?1:r,e.mapSelect.opacity=r})},applyClass:function(t,a){"voteshare"==t?$.each(currentMap.seatData,function(t,e){$("#i"+e.mapSelect.properties.info_id).removeClass(),$("#i"+e.mapSelect.properties.info_id).addClass("map "+a)}):"votesharechange"==t&&$.each(currentMap.seatData,function(t,e){$("#i"+e.mapSelect.properties.info_id).removeClass(),filters.opacities[t]<0?($("#i"+e.mapSelect.properties.info_id).addClass("map choro-minus"),filters.opacities[t]=Math.abs(filters.opacities[t]),e.mapSelect.opacity=Math.abs(e.mapSelect.opacity)):$("#i"+e.mapSelect.properties.info_id).addClass("map choro-plus")})},keyOnMap:function(t,e,a){$("#keyonmap").empty(),$("#keyonmap").show(),"voteshare"==e?n=$("."+a).css("background-color"):"votesharechange"==e&&(n="rgb(0, 0, 255)",a="choro-plus");var n,r=100*t/5;if("votesharechange"==e)for(var o=5;0<o;o--){var i="<div class='choro-minus' style='background-color: "+("rgba(255, 0, 0, "+.2*o+")")+"'>-"+(o*r).toFixed(1)+"%";.6==t&&5==o&&(i+="+"),i+="</div>",$("#keyonmap").append(i)}for(o=0;o<6;o++){i="<div class='"+a+"' style='background-color:"+n.replace(")",","+.2*o+")").replace("rgb","rgba")+"'>"+(o*r).toFixed(1)+"%";.6==t&&5==o&&(i+="+"),i+="</div>",$("#keyonmap").append(i)}},reset:function(){$("#keyonmap").hide(),$.each(currentMap.seatData,function(t,e){$("#i"+e.mapSelect.properties.info_id).removeClass(),$("#i"+e.mapSelect.properties.info_id).addClass("map "+e.seatInfo.current)}),$("#choro-voteshare option:eq(0)").prop("selected",!0),$("#choro-votesharechange option:eq(0)").prop("selected",!0)}},partylist={labour:"Labour",conservative:"Conservative",libdems:"Lib Dems",snp:"SNP",ukip:"Reform",plaidcymru:"Plaid Cymru",green:"Green",uu:"UUP",sinnfein:"Sinn FÃ©in",sdlp:"SDLP",dup:"DUP",alliance:"Alliance",other:"Other",others:"Others"},partyMap=[["conservative"],["labour"],["libdems"],["ukip"],["green"],["snp","plaidcymru","uu","dup","alliance","sdlp","sinnfein"],["other"]],partyToRegion={scotland:["conservative","labour","libdems","ukip","green","snp","other","others"],wales:["conservative","labour","libdems","ukip","green","plaidcymru","other","others"],northernireland:["dup","sinnfein","uu","sdlp","alliance","other","others"],default:["conservative","labour","libdems","ukip","green","other","others"]},regionlist={london:"London",southeastengland:"S.E. England",southwestengland:"S. W. England",westmidlands:"W. Midlands",northwestengland:"N. W. England",northeastengland:"N. E. England",yorkshireandthehumber:"Yorks & Humber",eastmidlands:"E. Midlands",eastofengland:"E. England",scotland:"Scotland",wales:"Wales",northernireland:"N. Ireland",unitedkingdom:"United Kingdom",greatbritain:"Great Britain",england:"England"},regionMap={unitedkingdom:["northeastengland","northwestengland","yorkshireandthehumber","southeastengland","southwestengland","eastofengland","eastmidlands","westmidlands","london","scotland","wales","northernireland"],greatbritain:["northeastengland","northwestengland","yorkshireandthehumber","southeastengland","southwestengland","eastofengland","eastmidlands","westmidlands","london","scotland","wales"],england:["northeastengland","northwestengland","yorkshireandthehumber","southeastengland","southwestengland","eastofengland","eastmidlands","westmidlands","london"]},seatsPerRegion2015={northeastengland:{labour:26,conservative:3},northwestengland:{labour:54,conservative:20,libdems:1},yorkshireandthehumber:{labour:37,conservative:17,libdems:0},southeastengland:{conservative:72,labour:8,green:1,libdems:2,others:1},southwestengland:{conservative:47,labour:7,libdems:1},eastofengland:{conservative:50,labour:7,libdems:1,ukip:0},eastmidlands:{conservative:31,labour:15},westmidlands:{conservative:35,labour:24},london:{labour:49,conservative:21,libdems:3},scotland:{snp:35,conservative:13,labour:7,libdems:4},wales:{labour:28,conservative:8,libdems:0,plaidcymru:4},northernireland:{uu:0,dup:10,sdlp:0,sinnfein:7,others:1}},filters={state:{majority:[0,100]},selectHandle:function(t,e){t=t.substring(7),"null"==e?delete filters.state[t]:"region"==t&&"england"==e?filters.state.region=regionMap.england:filters.state[t]=e,filters.filter()},byElection:function(t){0==currentMap.election&&(""==t?($("#filter-byElection").addClass("filter-button-active"),filters.state.byElection=!0):"filter-button-active"==t&&($("#filter-byElection").removeClass("filter-button-active"),delete filters.state.byElection)),1==currentMap.election&&(""==t?($("#filter-byElection").addClass("filter-button-active"),filters.state.gains=!0):"filter-button-active"==t&&($("#filter-byElection").removeClass("filter-button-active"),delete filters.state.gains)),filters.filter()},majority:function(t,e){"low"==t?filters.state.majority[0]=e:"high"==t&&(filters.state.majority[1]=e),filters.filter()},opacities:{},filter:function(){choro.reset(),$.each(currentMap.seatData,function(n,r){var o=!0;$.each(filters.state,function(t,e){var a;"majority"==t?((a=100*r.seatInfo.majority/r.seatInfo.turnout)<filters.state.majority[0]||a>filters.state.majority[1])&&(o=!1):"byElection"==t?null==r.seatInfo.byElection&&(o=!1):"gains"==t?r.seatInfo.current==currentMap.previousSeatData[n].seatInfo.current&&(o=!1):-1==e.indexOf(r.seatInfo[t])&&(o=!1)}),1==o?(filters.opacities[n]=1,r.filtered=!0):(filters.opacities[n]=.05,r.filtered=!1)}),filters.changeSnpBorders(),filters.display()},display:function(){$.each(filters.opacities,function(t,e){t=currentMap.seatData[t].mapSelect;t.opacity=e,d3.select("#i"+t.properties.info_id).attr("opacity",e)}),filters.getSeatlist()},reset:function(){filters.state={majority:[0,100]},$("#filter-current option:eq(0)").prop("selected",!0),$("#filter-region option:eq(0)").prop("selected",!0),$(".filter-button-active").removeClass("filter-button-active"),$("#filter-majority").get(0).reset(),$("#selectareatotals option:eq(0)").prop("selected",!0),voteTotals.calculate("unitedkingdom"),voteTotals.getMajority(),$("#seatlist-sort"+filters.activeSort).removeClass("sort-active"),filters.activeSort="name",$("#seatlist-sortname").addClass("sort-active"),filters.filter()},changeSnpBorders:function(){$(".map").each(function(t,e){var a=$(e).attr("class");-1!=["map snp","map libdems","map green","map sdlp"].indexOf(a)&&$(e).addClass("mapdark")})},filteredList:[],getSeatlist:function(){$("#seatlist-container").empty(),uiAttr.hideDiv("seatlist-extend"),filters.filteredList=[],$.each(currentMap.seatData,function(t,e){1==e.filtered&&filters.filteredList.push(new seatExtended(t,e))}),filters.sortState={name:"asc",current:"asc",majority:"desc",con:"desc",lab:"desc",lib:"desc",ukip:"desc",green:"desc",nat:"desc",oth:"desc"},filters.reorder("name","asc","simple")},activeSort:"name",sortState:{},tableSort:function(t){t=t.slice(13),$("#seatlist-sort"+filters.activeSort).removeClass("sort-active"),filters.activeSort=t,$("#seatlist-sort"+filters.activeSort).addClass("sort-active"),filters.reorder(t,filters.sortState[t],"extended"),"desc"==filters.sortState[t]?filters.sortState[t]="asc":"asc"==filters.sortState[t]&&(filters.sortState[t]="desc")},reorder:function(a,t,e){var n=filters.filteredList.map(function(t,e){return{ind:e,data:t}});"asc"==t&&n.sort(function(t,e){return t.data[a]<e.data[a]?-1:t.data[a]>e.data[a]?1:t.ind-e.ind}),"desc"==t&&n.sort(function(t,e){return t.data[a]<e.data[a]?1:t.data[a]>e.data[a]?-1:t.ind-e.ind}),filters.filteredList=n.map(function(t){return t.data}),"simple"==e&&filters.simpleList(),"extended"==e&&filters.extendedList()},simpleList:function(){$("#seatlist-total").text(filters.filteredList.length),$.each(filters.filteredList,function(t,e){e="<div class='extended-seat' onclick='mapAttr.clicked(currentMap.seatData[\""+e.name+"\"].mapSelect)'><div class='party-flair "+e.current+"'></div>"+e.name+"</div>";$("#seatlist-container").append(e)})},extendedList:function(){$("#seatlist-extended-data").empty(),uiAttr.hideDiv("seatlistbutton"),$.each(filters.filteredList,function(t,n){var e=n.name,a="<div style='margin-left: 10px' class='party-flair "+n.current+"'></div>",r=(currentMap.previousSeatData[n.name].seatInfo.current!=n.current&&(a+=" <span style='font-weight: bold'>GAIN</span>"),"</div><div>"),o="<div><div class='extended-seat' onclick='mapAttr.clicked(currentMap.seatData[\""+n.name+"\"].mapSelect)'>"+e+r+a+r+n.majority.toFixed(2),i=[n.con,n.lab,n.lib,n.ukip,n.green,n.nat,n.oth];$.each(partyMap,function(t,e){var a=filters.getChange(n.name,partyMap[t],i[t]);-1!=e.indexOf(n.current)?o+="</div><div style='font-weight: bold;"+a+"'>"+i[t]:o+="</div><div style='"+a+"'>"+i[t]}),o+="</div></div>",$("#seatlist-extended-data").append(o)})},getChange:function(a,t,e){var n=0;return $.each(t,function(t,e){e in currentMap.previousSeatData[a].partyInfo&&(n+=currentMap.previousSeatData[a].partyInfo[e].total)}),(n=(100*n/currentMap.previousSeatData[a].seatInfo.turnout).toFixed(2))<e?"color: green":e<n?"color: red":""}};function seatExtended(t,a){this.name=t,this.current=a.seatInfo.current,this.majority=parseFloat((100*a.seatInfo.majority/a.seatInfo.turnout).toFixed(2));var n=lab=lib=ukip=green=oth="",r=0;$.each(a.partyInfo,function(t,e){"conservative"==t&&(n=parseFloat((100*e.total/a.seatInfo.turnout).toFixed(2))),"labour"==t&&(lab=parseFloat((100*e.total/a.seatInfo.turnout).toFixed(2))),"libdems"==t&&(lib=parseFloat((100*e.total/a.seatInfo.turnout).toFixed(2))),"ukip"==t&&(ukip=parseFloat((100*e.total/a.seatInfo.turnout).toFixed(2))),"green"==t&&(green=parseFloat((100*e.total/a.seatInfo.turnout).toFixed(2))),"other"==t&&(oth=parseFloat((100*e.total/a.seatInfo.turnout).toFixed(2))),-1!=partyMap[5].indexOf(t)&&(r+=e.total)}),this.con=n,this.lab=lab,this.lib=lib,this.ukip=ukip,this.green=green,this.oth=oth,this.nat=0==r?"":parseFloat((100*r/a.seatInfo.turnout).toFixed(2))}var currentMap,mapAttr={width:600,height:875,active:d3.select(null),activeNode:null,clicked:function(t){mapAttr.activeNode=t,mapAttr.flashSeat(t);var e=path.bounds(t),a=Math.pow(e[1][0]-e[0][0],.5),n=Math.pow(e[1][1]-e[0][1],.5),r=(e[0][0]+e[1][0])/2,e=(e[0][1]+e[1][1])/2,a=.05/Math.max(a/mapAttr.width,n/mapAttr.height),n=[mapAttr.width/2-a*r,mapAttr.height/2-a*e];mapAttr.disableZoom(),svg.transition().duration(1500).call(zoom.transform,d3.zoomIdentity.translate(n[0],n[1]).scale(a)).on("end",mapAttr.enableZoom),uiAttr.showDiv("seat-information"),seatInfoTable.display(t.properties.name,currentMap.showTurnout)},flashSeat:function(e){var t="#i"+e.properties.info_id;current=d3.select(t),function t(){current.transition().duration(1500).attr("opacity",.02).transition().duration(1500).attr("opacity",e.opacity).on("end",t)}()},disableZoom:function(){svg.on("mousedown.zoom",null),svg.on("mousemove.zoom",null),svg.on("dblclick.zoom",null),svg.on("touchstart.zoom",null),svg.on("wheel.zoom",null),svg.on("mousewheel.zoom",null),svg.on("MozMousePixelScroll.zoom",null)},enableZoom:function(){svg.call(zoom)},reset:function(){null!=mapAttr.activeNode&&d3.select("#i"+mapAttr.activeNode.properties.info_id).transition().attr("opacity",mapAttr.activeNode.opacity),mapAttr.activeNode=null,mapAttr.disableZoom(),svg.transition().duration(1500).call(zoom.transform,d3.zoomIdentity).on("end",function(){mapAttr.enableZoom()})},zoomed:function(){g.style("stroke-width",1.5/d3.event.scale+"px"),g.attr("transform",d3.event.transform)},stopped:function(){d3.event.defaultPrevented&&d3.event.stopPropagation()},loadmap:function(r){g.selectAll(".map").data(topojson.feature(r.polygons,r.polygons.objects.map).features).enter().append("path").attr("class",function(t){var e;return t.properties.name in r.seatData&&(e=r.seatData[t.properties.name].seatInfo.current),t.properties.name in r.seatData&&"snp"==e?"mapdark snp":t.properties.name in r.seatData?"map "+e:"null"}).attr("opacity",1).attr("id",function(t){return"i"+t.properties.info_id}).attr("d",path).on("click",mapAttr.clicked).append("svg:title").text(function(t){return t.properties.name}).each(function(t){if(t.properties.name in currentMap.seatData){r.seatData[t.properties.name].mapSelect=t,r.seatData[t.properties.name].mapSelect.opacity=1,filters.opacities[t.properties.name]=1,r.seatData[t.properties.name].filtered=!0;var e=0;for(a in r.seatData[t.properties.name].partyInfo)e+=r.seatData[t.properties.name].partyInfo[a].total;r.seatData[t.properties.name].seatInfo.turnout=e;var a,n=0;for(a in r.previousSeatData[t.properties.name].partyInfo)n+=r.previousSeatData[t.properties.name].partyInfo[a].total;r.previousSeatData[t.properties.name].seatInfo.turnout=n}}),g.append("path").datum(topojson.mesh(r.polygons,r.polygons.objects.map,function(t,e){return t.properties.region!=e.properties.region&&t!=e})).attr("d",path).attr("class","boundaries")}},projection=d3.geoAlbers().center([-.5,54.4]).rotate([2.25,0]).parallels([51,60]).scale(5300).translate([mapAttr.width/2,mapAttr.height/2]),path=d3.geoPath().projection(projection),zoom=d3.zoom().scaleExtent([1,8]).on("zoom",mapAttr.zoomed);function getData(e){$.when($.getJSON(e.mapurl,function(t){e.polygons=t}),$.getJSON(e.dataurl,function(t){e.seatData=t,currentMap=e}),$.getJSON(e.previous,function(t){e.previousSeatData=t})).then(function(){pageLoadEssentials()})}function pageLoadEssentials(){mapAttr.loadmap(currentMap),filters.opacities={},filters.reset(),params.checkParams(),$("#userinput-table input").each(function(){this.value=0}),userInput.inputs={};var t=Object.keys(currentMap.seatData);t.sort(),$(function(){$("#searchseats").autocomplete({source:t,select:function(t,e){searchSeats(e.item.label)}})}),$("#predictbutton").addClass("hidden"),uiAttr.pageLoadDiv(),"prediction_new"!=currentMap.name&&"prediction"!=currentMap.name&&"current"!=currentMap.name?$("#instructions").remove():$(function(){$("#lastpollster").load("lastpollster.html")}),1==currentMap.election?$("#filter-byElection").text("Gains"):0==currentMap.election&&$("#filter-byElection").text("By-Elections"),"election2010"==currentMap.name||"2017-600seat"==currentMap.name?$("#filter-byElection").hide():$("#filter-byElection").show(),currentMap.seatDataBackup=jQuery.extend(!0,{},currentMap.seatData),1==currentMap.predict&&(userInput.seatDataCopy=jQuery.extend(!0,{},currentMap.seatData)),"2017-600seat"==currentMap.name||"prediction-600seat"==currentMap.name?$("#seat-600 ").show():$("#seat-600 ").hide(),0==currentMap.battlegrounds?$("#battlegrounds").hide():$("#battlegrounds").show(),0==currentMap.redistribute&&$("#redistribute").hide(),-1<navigator.userAgent.toLowerCase().indexOf("firefox")&&($("div").css("font-size","98%"),$("select").css("font-size","98%")),"myprediction"==currentMap.name?$("#myprediction").show():$("#myprediction").hide()}function searchSeats(t){mapAttr.clicked(currentMap.seatData[t].mapSelect)}function pageSetting(t,e,a,n,r,o,i,s,l){this.name=t,this.mapurl=e,this.dataurl=a,this.previous=n,this.election=r,this.predict=o,this.battlegrounds=i,this.redistribute=s,this.showTurnout=l,this.seatData={},this.previousSeatData={},this.polygons={}}var dataurls={map650:"650map.json",map600:"600map.json",map650_new:"650map_new.json",predict:"houseofcommons/prediction.json",predict_new:"houseofcommons/prediction_new.json",current:"houseofcommons/current.json",e2019:"houseofcommons/2019election.json",e2019_new:"houseofcommons/2019election_new.json",e2017:"houseofcommons/2017election.json",e2015:"houseofcommons/2015election.json",e2010:"houseofcommons/2010election.json",e2017_600:"houseofcommons/2017election_600seat.json",predict_600:"houseofcommons/prediction_600seat.json"},currentParliament=new pageSetting("current",dataurls.map650_new,dataurls.current,dataurls.e2019_new,!0,!1,!1,!1,!0),election2019=new pageSetting("election2019",dataurls.map650,dataurls.e2019,dataurls.e2017,!0,!1,!0,!1,!0),election2019_new=new pageSetting("election2019_new",dataurls.map650_new,dataurls.e2019_new,dataurls.e2019_new,!0,!1,!0,!1,!1),election2017=new pageSetting("election2017",dataurls.map650,dataurls.e2017,dataurls.e2015,!0,!1,!0,!1,!0),election2015=new pageSetting("election2015",dataurls.map650,dataurls.e2015,dataurls.e2010,!0,!1,!1,!1,!0),election2010=new pageSetting("election2010",dataurls.map650,dataurls.e2010,dataurls.e2010,!1,!1,!1,!1,!0),prediction=new pageSetting("prediction",dataurls.map650,dataurls.predict,dataurls.e2019,!0,!1,!0,!1,!1),prediction_new=new pageSetting("prediction_new",dataurls.map650_new,dataurls.predict_new,dataurls.e2019_new,!0,!1,!0,!1,!1),predictit=new pageSetting("predictit",dataurls.map650,dataurls.e2019,dataurls.e2019,!0,!0,!0,!1,!1),predictit_new=new pageSetting("predictit_new",dataurls.map650_new,dataurls.e2019_new,dataurls.e2019_new,!0,!0,!0,!1,!1),election2017_600seat=new pageSetting("2017-600seat",dataurls.map600,dataurls.e2017_600,dataurls.e2017_600,!1,!1,!1,!1,!1),prediction_600seat=new pageSetting("prediction-600seat",dataurls.map600,dataurls.predict_600,dataurls.e2017_600,!0,!1,!1,!1,!1),predictit_2015=new pageSetting("prediction_2015",dataurls.map650,dataurls.e2015,dataurls.e2015,!0,!0,!0,!1);function initialization(){var t=getParameterByName("map",url),e=urlParamMap[t];uiAttr.changeNavBar(e.name),$(".map").remove(),$(document).ready(function(){getData(e)})}function getParameterByName(t,e){e=e||window.location.href,t=t.replace(/[\[\]]/g,"\\$&");t=new RegExp("[?&]"+t+"(=([^&#]*)|&|#|$)").exec(e);return t?t[2]?decodeURIComponent(t[2].replace(/\+/g," ")):"":null}var url=window.location.href,urlParamMap={null:currentParliament,current:currentParliament,prediction:prediction,prediction_new:prediction_new,predictit:predictit,predictit_new:predictit_new,election2019:election2019,election2019_new:election2019_new,election2017:election2017,election2015:election2015,election2010:election2010,election2017_600seat:election2017_600seat,prediction_600seat:prediction_600seat,predictit_2015:predictit_2015},params={possibleFilterParams:["incumbent","region","majlow","majhigh","gains","byelection"],possibleBattlegroundParams:["incumbent","challenger","region","majlow","majhigh"],checkParams:function(){params.filters()},filters:function(){var n=!1;return $.each(params.possibleFilterParams,function(t,e){var a=getParameterByName(e,url);null!=a&&(a=a.toLowerCase(),"incumbent"==e?filters.selectHandle("filter-current",a):"region"==e?filters.selectHandle("filter-region",a):"majlow"==e?filters.majority("low",a):"majhigh"==e?filters.majority("high",a):"gains"!=e&&"byelection"!=e||"yes"!=a&&"true"!=a||filters.byElection(""),n=!0)}),1==n},battleground:function(){1==currentMap.battlegrounds&&$.each(params.possibleBattlegroundParams,function(t,e){var a=getParameterByName(e,url);null!=a&&battleground.handle("battlegrounds-"+e,a)})}},redistribute={active:!1,validInput:!0,ukip:!1,green:!1,values:{ukip:{conservative:0,labour:0,libdems:0,notVoting:100},green:{conservative:0,labour:0,libdems:0,notVoting:100}},check:function(t,e,a){valueInt=parseInt(a),Number.isInteger(valueInt)?this.values[t][e]=valueInt:this.values[t][e]=0;this.values[t].notVoting;a=this.values[t].conservative+this.values[t].labour+this.values[t].libdems,this.values[t].notVoting=100-a,e=this.values[t].notVoting;this.validInput=!0,e<0&&(this.validInput=!(e="<0")),$("#redist-"+t+"-notvoting").text(e),100!=this.values[t].notVoting?this[t]=!0:this[t]=!1},handle:function(){this.validInput?(this.reset(),$.each(this.values,function(a,n){1==redistribute[a]&&$.each(currentMap.seatData,function(t,e){a in e.partyInfo&&0==e.partyInfo[a].standing&&redistribute.calculate(e,a,n)})}),filters.reset()):alert("Percentages add up to more than 100!")},calculate:function(a,t,e){var n=a.partyInfo[t].total,r=(a.seatInfo.turnout-=n*e.notVoting/100,a.seatInfo.turnout=Math.round(a.seatInfo.turnout),$.each(e,function(t,e){t in a.partyInfo&&(a.partyInfo[t].total+=e*n/100,a.partyInfo[t].total=Math.round(a.partyInfo[t].total))}),delete a.partyInfo[t],null),o=0,i=[];$.each(a.partyInfo,function(t,e){i.push(e.total),e.total>o&&(o=e.total,r=t)}),i.sort(function(t,e){return t<e}),a.seatInfo.current=r,a.seatInfo.majority=i[0]-i[1]},reset:function(){currentMap.seatData=jQuery.extend(!0,{},currentMap.seatDataBackup),filters.reset()},resetInputs:function(){$("#redist-table").find("input:text").val(0),$("#redist-ukip-notvoting").text("100"),$("#redist-green-notvoting").text("100"),this.green=!1,this.ukip=!1,this.values={ukip:{conservative:0,labour:0,libdems:0,notVoting:100},green:{conservative:0,labour:0,libdems:0,notVoting:100}},this.reset()}},seatInfoTable={party:null,gain:null,display:function(t,e){t=new activeSeat(t);seatInfoTable.seatInfo(t,e),seatInfoTable.voteTable(t.votes),seatInfoTable.barChart(t.votes)},seatInfo:function(t,e){$("#information-party .party-flair").removeClass(seatInfoTable.party),$("#information-gain .party-flair").removeClass(seatInfoTable.gain),null!=t.byElection?(t.name+="*",$("#information-byelection").text("*By-election on "+t.byElection)):$("#information-byelection").text(""),$("#information-seatname-span").text(t.name),$("#information-region").text(regionlist[t.region]),$("#information-party .party-name").text(partylist[t.current]),$("#information-party .party-flair").addClass(t.current),t.current!=t.previous?($("#information-gain .party-name").text("FROM "+partylist[t.previous]),$("#information-gain .party-flair").addClass(t.previous)):$("#information-gain .party-name").text("");var a="Majority: "+(100*t.majority/t.turnout).toFixed(2)+"%",a=(e&&(a+="= "+t.majority),$("#information-majority").text(a),(100*t.turnout/t.electorate).toFixed(2));e?$("#information-turnout").text("Turnout : "+t.turnout+" = "+a+"%"):$("#information-turnout").text(""),seatInfoTable.party=t.current,seatInfoTable.gain=t.previous},barChart:function(t){$("#information-bar").empty();for(var e=[],a=0;a<t.length;a++)5<t[a].totalPercentage&&e.push(t[a]);var n=(t=e).length,r=10,o=0,i=10,s=25,l=200-s-o,u=200-r-i,c=d3.min([60,l/n-2]),l=d3.select("#information-bar").append("svg").attr("width",l+s+o).attr("height",u+r+i).append("g").attr("transform","translate("+s+","+r+")"),o=d3.scaleOrdinal().range([0,n*(c+2)]),i=d3.axisBottom().scale(o),p=d3.scaleLinear().range([u,0]),s=d3.axisLeft().scale(p).ticks(6),r=d3.max(t,function(t){return+t.totalPercentage});p.domain([0,d3.max([60,r+(10-r%10)])]),l.append("g").attr("class","x axis").attr("transform","translate(0,"+u+")").call(i),l.append("g").attr("class","y axis").call(s),l.selectAll("rect").data(t).enter().append("rect").attr("x",function(t,e){return 2*(e+1)+c*e}).attr("width",c).attr("y",u).attr("height",0).attr("class",function(t){return t.party}).transition().delay(function(t,e){return 250*e/2}).duration(250).attr("y",function(t){return p(t.totalPercentage)}).attr("height",function(t){return u-p(t.totalPercentage)})},voteTable:function(t){$("#information-chart").empty();for(var e=0;e<t.length;e++){var a="<div class='party-info-table'>",n=(a=(a+="<div class='party-flair "+t[e].party+"'></div>")+("<div>"+t[e].name+"</div>"),"");0!=t[e].change&&(n="("+t[e].change+")",n="<span style='color: "+(0<t[e].change?"green":"red")+";'>"+n+"</span>"),a=a+("<div>"+t[e].totalPercentage+"% "+n+"</div>")+"</div>",$("#information-chart").append(a)}}};function activeSeat(t){this.name=t;var e,a,n,r,o=currentMap.seatData[t].seatInfo,i=currentMap.seatData[t].partyInfo,s=(this.region=o.region,this.current=o.current,this.previous=currentMap.previousSeatData[t].seatInfo.current,this.electorate=o.electorate,this.turnout=+o.turnout.toFixed(0),this.majority=o.majority,this.byElection=o.byElection,this.votes=[],currentMap.previousSeatData[t].partyInfo),l=0;for(e in $.each(s,function(t,e){l+=e.total}),i)0<i[e].total&&(a=e in s?(100*s[e].total/l).toFixed(2):0,r=((n=(100*(partyData=i[e]).total/this.turnout).toFixed(2))-a).toFixed(2),"other"!=e&&"others"!=e||(r="0"),this.votes.push({party:e,name:partyData.name,totalPercentage:n,previousTotalPercentage:a,change:r}));this.votes.sort(function(t,e){return e.totalPercentage-t.totalPercentage})}var uiAttr={changeNavBar:function(t){$(".navbaractive").removeClass("navbaractive");t="#nav-"+t,$(t).addClass("navbaractive"),t=$(t).text();t.endsWith("(New) ")&&(t=t.replace("(New)","(New Boundaries)")),$("#pagetitle").html(t),document.title=t},clickMapButton:function(t){var e=$(t).attr("class"),a=$(t).attr("id");-1==e.indexOf("mapbuttonactive")?($(t).addClass("mapbuttonactive"),uiAttr.showDiv(a)):uiAttr.hideDiv(a)},showDiv:function(t){uiAttr.zIndexCheck(t),"battlegrounds"==t&&(battleground.active=!0),"redistribute"==t&&(redistribute.active=!0),$(uiAttr.buttonToDiv[t]).show(),$(uiAttr.buttonToDiv[t]).mousedown(function(){uiAttr.zIndexCheck(t),uiAttr.zIndexShuffle()}).draggable({handle:"h2",containment:"#wrapper"}),uiAttr.zIndexShuffle()},hideDiv:function(t){var e=uiAttr.zIndexTracker.indexOf(t);$("#"+t).removeClass("mapbuttonactive"),"battlegrounds"==t&&(battleground.active=!1),"redistribute"==t&&(redistribute.active=!1),-1!=e&&uiAttr.zIndexTracker.splice(e,1),$(uiAttr.buttonToDiv[t]).hide(),uiAttr.zIndexShuffle()},buttonToDiv:{"seat-information":"#seat-information",votetotalsbutton:"#votetotals",filtersbutton:"#filters",choroplethsbutton:"#choropleths",seatlistbutton:"#seatlist","seatlist-extend":"#seatlist-extended",predictbutton:"#userinput","seat-600":"#seat-600",battlegrounds:"#battlegroundsselect",redistribute:"#redistributeselect"},zIndexTracker:[],zIndexCheck:function(t){var e,a;-1==uiAttr.zIndexTracker.indexOf(t)?uiAttr.zIndexTracker.push(t):(e=uiAttr.zIndexTracker.indexOf(t),a=uiAttr.zIndexTracker.length-1,uiAttr.zIndexTracker.splice(e,1),uiAttr.zIndexTracker.splice(a,0,t))},zIndexShuffle:function(){for(var t=uiAttr.zIndexTracker,e=0;e<t.length;e++)$(uiAttr.buttonToDiv[t[e]]).css("z-index",e+1)},pageLoadDiv:function(t){$.each(uiAttr.buttonToDiv,function(t,e){"votetotalsbutton"==t||"filtersbutton"==t||"choroplethsbutton"==t||"seatlistbutton"==t?uiAttr.showDiv(t):"predictbutton"==t&&1==currentMap.predict?($("#predictbutton").removeClass("hidden").addClass("mapbuttonactive"),uiAttr.showDiv(t)):battleground.active?uiAttr.showDiv("battlegroundsbutton"):redistribute.active?uiAttr.showDiv("redistributebutton"):uiAttr.hideDiv(t)})}},userInput={seatDataCopy:{},advancedDivs:regionMap.england,showAdvanced:function(){delete userInput.inputs.england,$("#userinput").css("top","400px"),$("#userinput-england").addClass("hidden"),$("#userinput-england input").each(function(){this.value=0}),$("#userinput-show").addClass("hidden"),$("#userinput-hide").removeClass("hidden"),$.each(userInput.advancedDivs,function(t,e){$("#userinput-"+e).removeClass("hidden")})},hideAdvanced:function(){$("#userinput").css("top","577px"),$.each(userInput.advancedDivs,function(t,e){delete userInput.inputs[e]}),$("#userinput-england").removeClass("hidden"),$("#userinput-show").removeClass("hidden"),$("#userinput-hide").addClass("hidden"),$.each(userInput.advancedDivs,function(t,e){$("#userinput-"+e).addClass("hidden"),$("#userinput-"+e+" input").each(function(){this.value=0})})},inputs:{},over100:!1,check:function(t,e,a){t in userInput.inputs||(userInput.inputs[t]={}),(""==a||a<0)&&(a=0),userInput.inputs[t][e]=Math.round(100*parseFloat(a))/100;var n=0,r=0;$.each(userInput.inputs[t],function(t,e){n+=e,r<e&&(r=e)}),n=100*parseFloat(n)/100,0==r&&delete userInput.inputs[t],100<n?($("#userinput-"+t+"-other").text("<0"),userInput.over100=!0):($("#userinput-"+t+"-other").text((100-n).toFixed(1)),userInput.over100=!1)},handle:function(){1==userInput.over100?alert("Some percentages add up to more than 100!"):($.each(userInput.inputs,function(t,e){var a=0;if("scotland"==t)for(var n=partyToRegion.scotland,r=0;r<n.length;r++)n[r]in e||(e[n[r]]=0),a+=e[n[r]];else if("wales"==t)for(n=partyToRegion.wales,r=0;r<n.length;r++)n[r]in e||(e[n[r]]=0),a+=e[n[r]];else if("northernireland"==t)for(n=partyToRegion.northernireland,r=0;r<n.length;r++)n[r]in e||(e[n[r]]=0),a+=e[n[r]];else for(n=partyToRegion.default,r=0;r<n.length;r++)n[r]in e||(e[n[r]]=0),a+=e[n[r]];e.other=a=100-a,delete e.others,userInput.calculate(t,e),delete e.other}),$(".map").remove(),mapAttr.loadmap(currentMap),filters.reset(),uiAttr.pageLoadDiv())},calculate:function(t,e){var t=userInput.getOldTotals(t),a=t[0],t=t[1],e=userInput.getUserChange(e,a,t);userInput.seatAnalysis(e,t)},getOldTotals:function(t){n=t in regionMap?regionMap[t]:[t],e=-1!=["scotland","wales","northernireland"].indexOf(t)?partyToRegion[t]:partyToRegion.default;for(var n,e,r=0,o={},i={totals:{}},a=0;a<n.length;a++)i[n[a]]={},i.totals[n[a]]=0;for(a=0;a<e.length;a++)for(var s=o[e[a]]=0;s<n.length;s++)i[n[s]][e[a]]=0;return $.each(currentMap.previousSeatData,function(t,a){$.each(e,function(t,e){-1!=n.indexOf(a.seatInfo.region)&&e in a.partyInfo&&(r+=a.partyInfo[e].total,o[e]+=a.partyInfo[e].total,i[a.seatInfo.region][e]+=a.partyInfo[e].total,i.totals[a.seatInfo.region]+=a.partyInfo[e].total)})}),$.each(o,function(t,e){o[t]=100*e/r}),o.other+=o.others,delete o.others,$.each(i,function(a,t){"totals"!=a&&$.each(e,function(t,e){i[a][e]/=.01*i.totals[a]}),i[a].other+=i[a].others,delete i[a].others}),delete i.totals,[o,i]},getUserChange:function(i,s,l){var u={};return $.each(l,function(a,t){var n={},r=($.each(i,function(t,e){n[t]=l[a][t]+(i[t]-s[t]),n[t]<0&&(n[t]=0)}),0),o=($.each(n,function(t,e){r+=e}),r/100);$.each(n,function(t,e){n[t]=e/o}),u[a]=n}),$.each(l,function(a,t){$.each(i,function(t,e){u[a][t]=u[a][t]-l[a][t]})}),u},seatAnalysis:function(p,d){$.each(currentMap.seatData,function(r,o){if(o.seatInfo.region in d){var i={},t=($.each(p[o.seatInfo.region],function(t,e){var a=0,n=(t in currentMap.previousSeatData[r].partyInfo&&(a=100*currentMap.previousSeatData[r].partyInfo[t].total/currentMap.previousSeatData[r].seatInfo.turnout),"other"==t&&"others"in currentMap.previousSeatData[r].partyInfo&&(a+=100*currentMap.previousSeatData[r].partyInfo.others.total/currentMap.previousSeatData[r].seatInfo.turnout),p[o.seatInfo.region][t]),n=a+n;i[t]=n=n<.1*a?.1*a:n}),0);for(a in i)t+=i[a];var e=t/100;for(a in i)i[a]/=e;var a,n=[];for(a in i)n.push([a,i[a]]);n.sort(function(t,e){return t[1]-e[1]});var s=n.pop(),l=n.pop(),u=s[0],s=s[1]-l[1],c={seatInfo:{current:u,majority:parseInt(s*o.seatInfo.turnout/100),electorate:o.seatInfo.electorate,turnout:o.seatInfo.turnout,region:o.seatInfo.region},partyInfo:{}};$.each(i,function(t,e){0<e&&(c.partyInfo[t]={total:e*o.seatInfo.turnout/100,name:partylist[t]})}),currentMap.seatData[r].seatInfo=c.seatInfo,currentMap.seatData[r].partyInfo=c.partyInfo}}),currentMap.seatDataBackup=jQuery.extend(!0,{},currentMap.seatData),redistribute.resetInputs()},reset:function(){redistribute.resetInputs(),currentMap.seatData=jQuery.extend(!0,{},userInput.seatDataCopy),$(".map").remove(),pageLoadEssentials()}},voteTotals={data:[],totals:{},electorate:{},turnout:null,calculate:function(t){"null"==t&&(t="unitedkingdom"),voteTotals.data=[],voteTotals.electorate=0,e=t in regionMap?regionMap[t]:[t];var e,a,o=[];for(a in currentMap.seatData)-1!=e.indexOf(currentMap.seatData[a].seatInfo.region)&&(o.push(a),voteTotals.electorate+=currentMap.seatData[a].seatInfo.electorate);var i={name:"total",seats:o.length,change:null,votes:0,oldvotes:0,votePercent:null,votePercentChange:null},s={};$.each(partylist,function(a,t){var n,r={party:a,name:t,seats:0,change:0,votes:0,oldvotes:0,votePercent:null,votePercentChange:null};$.each(o,function(t,e){currentMap.seatData[e].seatInfo.current==a&&(r.seats+=1),currentMap.previousSeatData[e].seatInfo.current==a&&(r.change+=1),a in currentMap.seatData[e].partyInfo&&(i.votes+=currentMap.seatData[e].partyInfo[a].total,r.votes+=currentMap.seatData[e].partyInfo[a].total),1==currentMap.election&&a in currentMap.previousSeatData[e].partyInfo&&(i.oldvotes+=currentMap.previousSeatData[e].partyInfo[a].total,r.oldvotes+=currentMap.previousSeatData[e].partyInfo[a].total)}),r.change=r.seats-r.change,"2017-600seat"==currentMap.name&&(n=0,$.each(e,function(t,e){a in seatsPerRegion2015[e]&&(n+=seatsPerRegion2015[e][a])}),r.change=r.seats-n),s[a]=r}),voteTotals.totals=i,$.each(partylist,function(t,e){var a;s[t].votePercent=+(100*s[t].votes/i.votes).toFixed(2),1==currentMap.election&&(a=+(100*s[t].oldvotes/i.oldvotes).toFixed(2),s[t].votePercentChange=+(s[t].votePercent-a).toFixed(2))}),voteTotals.turnout=+(100*i.votes/voteTotals.electorate).toFixed(2),Object.keys(s.other).forEach(function(t){"name"!=t&&"party"!=t&&(s.other[t]+=s.others[t])}),s.other.votePercentChange=+s.other.votePercentChange.toFixed(2),delete s.others,$.each(s,function(t,e){0<e.votes&&voteTotals.data.push(e)}),$("#votetotalsarea").text(regionlist[t]),voteTotals.sortState={votes:"desc",seats:"desc",votePercent:"desc",votePercentChange:"desc"},voteTotals.tableSortHandler("votes")},reorder:function(a,t){"asc"==t?voteTotals.data.sort(function(t,e){return t[a]-e[a]}):"desc"==t&&voteTotals.data.sort(function(t,e){return e[a]-t[a]}),voteTotals.display()},activeSort:"votes",sortState:{},tableSortHandler:function(t){$("#votetotals-sort"+voteTotals.activeSort).removeClass("sort-active"),voteTotals.activeSort=t,voteTotals.reorder(voteTotals.activeSort,voteTotals.sortState[voteTotals.activeSort]),$("#votetotals-sort"+t).addClass("sort-active"),"desc"==voteTotals.sortState[t]?voteTotals.sortState[t]="asc":"asc"==voteTotals.sortState[t]&&(voteTotals.sortState[t]="desc")},display:function(){$("#votetotals-table-data").empty(),"election2015"==currentMap.name||"election2010"==currentMap.name||"election2017"==currentMap.name||"election2019"==currentMap.name?$("#votetotals-turnout").text("Turnout: "+voteTotals.turnout+"%"):$("#votetotals-turnout").text(" ");var u="</div><div>",t=($.each(voteTotals.data,function(t,e){var a,n="<div class='party-flair "+e.party+"'></div>"+e.name,r=e.seats,o=e.change,i=parseInt(e.votes),s=e.votePercent.toFixed(2),l=null,e=(null!=e.votePercentChange&&(l=e.votePercentChange.toFixed(2)),u),l=(0<o?(e="</div><div style='color: green'>",o="+"+o):o<0&&(e="</div><div style='color: red'>"),0<=l?a="</div><div style='color: green'>"+l:l<0&&(a="</div><div style='color: red'>"+l),"<div><div>"+n+u+r+e+o+u+i.toLocaleString()+u+s+a+"</div></div>");$("#votetotals-table-data").append(l)}),"</div><div class='lastrow'>"),t=($("#votetotals-table-data").append("<div><div class='lastrow'>Totals"+t+voteTotals.totals.seats+t+"&nbsp;"+t+voteTotals.totals.votes.toLocaleString()+t+"&nbsp;"+t+"&nbsp;</div></div>"),{true:"block",false:"none"});$("#votetotals-table-titles > div > div:nth-child(6)").css("display",t[currentMap.election]),$("#votetotals-table-data > div > div:nth-child(6)").css("display",t[currentMap.election])},getMajority:function(){var a=0,n=null,t=($.each(voteTotals.data,function(t,e){e.seats>a&&(a=e.seats,n=e.name)}),"650map.json"==currentMap.mapurl||"650map_new.json"==currentMap.mapurl?t=650:"600map.json"==currentMap.mapurl&&(t=600),t/2);t<a?(t=2*(a-t),$("#majoritytitle").text(n+" Majority: "+t)):$("#majoritytitle").text("Hung Parliament")}};