/*! principalfish 05-04-2024 */
var filter={pollsDisplay:!0,modelDisplay:!0,movingDisplay:!0,datestart:new Date(2015,4,6),dateend:new Date(2017,5,8),date:function(t,e){"dateselect-start"==e&&(filter.datestart=new Date(t)),"dateselect-end"==e&&(filter.dateend=new Date(t));e=new Date(2015,4,6),t=new Date(2017,5,8);(filter.datestart<=e||"Invalid Date"==filter.datestart)&&(filter.datestart=e),(filter.dateend>=t||"Invalid Date"==filter.dateend)&&(filter.dateend=t),filter.redraw()},company:function(t){-1==companies.indexOf(t)?companies.push(t):(t=companies.indexOf(t),companies.splice(t,1)),filter.redraw()},redraw:function(){$("#plot g").empty(),pageLoad()}},plot={drawGridlines:function(){x.domain([filter.datestart,filter.dateend]),y.domain([0,65]),y2.domain([0,422.5]),svg.append("g").attr("class","grid").attr("transform","translate(0,"+height+")").call(plot.makeXGridlines().tickSize(-height).tickFormat("")),svg.append("g").attr("class","grid").call(plot.makeYGridlines().tickSize(-width).tickFormat(""))},draw:function(t,e){1==filter.movingDisplay&&svg.append("path").data([t]).attr("class","line "+e).attr("d",valueline),1==filter.pollsDisplay&&svg.selectAll("dot").data(t).enter().append("circle").attr("r",1).attr("cx",function(t){return x(t.date)}).attr("cy",function(t){return y(t.percentage)}).attr("class",e).append("svg:title").text(function(t){return t.company+" "+t.date.getDate()+"/"+(t.date.getMonth()+1)+"/"+t.date.getFullYear()+" : "+t.percentage+"%"}),1==filter.modelDisplay&&svg.append("path").data([modelDataDisplay[e]]).attr("class","modelline "+e).attr("d",modelline).style("stroke-dasharray","10, 5")},makeXGridlines:function(){return d3.axisBottom(x).ticks(5)},makeYGridlines:function(){return d3.axisLeft(y).ticks(10)},drawAxes:function(){var t=filter.datestart,e=filter.dateend,a=Math.floor((e-t)/2628e6);25<a&&(a=25),svg.append("g").attr("transform","translate(0,"+height+")").call(d3.axisBottom(x).ticks(a).tickFormat(timeFormat)).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-45)"),svg.append("g").call(d3.axisLeft(y)),svg.append("g").call(d3.axisRight(y2).ticks(15)).attr("transform","translate("+width+" , 0)"),svg.append("text").attr("transform","translate("+width/2+" ,"+(height+margin.top+30)+")").style("text-anchor","middle").text("Date"),svg.append("text").attr("transform","rotate(-90)").attr("y",0-margin.left).attr("x",0-height/2).attr("dy","1em").style("text-anchor","middle").text("Percentage"),svg.append("text").attr("transform","rotate(90)").attr("y",-width-margin.right).attr("x",0+height/2).attr("dy","1em").style("text-anchor","middle").text("Seats"),1==filter.modelDisplay&&svg.append("path").data([[{date:t,seats:326},{date:e,seats:326}]]).attr("class","majorityline").attr("d",majorityline).style("stroke-dasharray","2, 2")}},margin={top:20,right:40,bottom:60,left:40},width=1e3-margin.left-margin.right,height=800-margin.top-margin.bottom,parseTime=d3.timeParse("%d-%b-%y"),x=d3.scaleTime().range([0,width]),y=d3.scaleLinear().range([height,0]),y2=d3.scaleLinear().range([height,0]),timeFormat=d3.timeFormat("%b %y"),valueline=d3.line().x(function(t){return x(t.date)}).y(function(t){return y(t.moving)}),modelline=d3.line().x(function(t){return x(t.date)}).y(function(t){return y2(t.seats)}),majorityline=d3.line().x(function(t){return x(t.date)}).y(function(t){return y2(t.seats)}),pollData={labour:[],conservative:[],libdems:[],snp:[],green:[],ukip:[],others:[]},modelData={labour:[],conservative:[],libdems:[],snp:[],green:[],ukip:[],others:[]},modelDataDisplay={},companies=[];function getData(){$.when($.getJSON("polltracker/scatter1.json",function(t){$.each(t.polls,function(t,e){var a=new Date(e.date[2],e.date[1]-1,e.date[0]);$.each(pollData,function(t){-1==companies.indexOf(e.company)&&companies.push(e.company),pollData[t].push({company:e.company,date:a,percentage:e[t]})})}),$.each(t.models,function(t,e){var a=new Date(Date.parse(e.date));$.each(e,function(t,e){"date"!=t&&modelData[t].push({date:a,seats:e})})})})).then(function(){pageLoad()})}function pageLoad(){plot.drawGridlines(),$.each(modelData,function(t,e){for(var a,n=[],r=0;r<e.length;r++)inDateRange(e[r].date)&&(a={date:e[r].date,seats:e[r].seats},n.push(a));modelDataDisplay[t]=n}),$.each(pollData,function(t,e){for(var a=[],n=[],r=0;r<e.length;r++)if(-1!=companies.indexOf(e[r].company)&&inDateRange(e[r].date)){var i={company:e[r].company,percentage:e[r].percentage,date:e[r].date,moving:null},d=(a.push(e[r].percentage),12<a.length&&a.splice(0,1),0);for(percentage in a)d+=a[percentage];i.moving=d/a.length,n.push(i)}plot.draw(n,t)}),plot.drawAxes()}function inDateRange(t){return t>=filter.datestart&&t<=filter.dateend}$(document).ready(function(){getData()});