/*! principalfish 22-05-2017 */
function getData(){$.when($.getJSON("polltracker/scatter.json",function(a){$.each(a.polls,function(a,b){var c=new Date(b.date[2],b.date[1]-1,b.date[0]);$.each(pollData,function(a){companies.indexOf(b.company)==-1&&companies.push(b.company),pollData[a].push({company:b.company,date:c,percentage:b[a]})})}),$.each(a.models,function(a,b){var c=new Date(Date.parse(b.date));$.each(b,function(a,b){"date"!=a&&modelData[a].push({date:c,seats:b})})})})).then(function(){pageLoad()})}function pageLoad(){plot.drawGridlines(),$.each(modelData,function(a,b){for(var c=[],d=0;d<b.length;d++)if(inDateRange(b[d].date)){var e={date:b[d].date,seats:b[d].seats};c.push(e)}modelDataDisplay[a]=c}),$.each(pollData,function(a,b){for(var c=[],d=[],e=0;e<b.length;e++)if(companies.indexOf(b[e].company)!=-1&&inDateRange(b[e].date)){var f={company:b[e].company,percentage:b[e].percentage,date:b[e].date,moving:null};c.push(b[e].percentage),c.length>12&&c.splice(0,1);var g=0;for(percentage in c)g+=c[percentage];var h=g/c.length;f.moving=h,d.push(f)}plot.draw(d,a)}),plot.drawAxes()}function inDateRange(a){return a>=filter.datestart&&a<=filter.dateend}var filter={pollsDisplay:!0,modelDisplay:!0,movingDisplay:!0,datestart:new Date(2015,4,6),dateend:new Date(2017,5,8),date:function(a,b){"dateselect-start"==b&&(filter.datestart=new Date(a)),"dateselect-end"==b&&(filter.dateend=new Date(a));var c=new Date(2015,4,6),d=new Date(2017,5,8);(filter.datestart<=c||"Invalid Date"==filter.datestart)&&(filter.datestart=c),(filter.dateend>=d||"Invalid Date"==filter.dateend)&&(filter.dateend=d),filter.redraw()},company:function(a){if(companies.indexOf(a)==-1)companies.push(a);else{var b=companies.indexOf(a);companies.splice(b,1)}filter.redraw()},redraw:function(){$("#plot g").empty(),pageLoad()}},plot={drawGridlines:function(){x.domain([filter.datestart,filter.dateend]),y.domain([0,65]),y2.domain([0,422.5]),svg.append("g").attr("class","grid").attr("transform","translate(0,"+height+")").call(plot.makeXGridlines().tickSize(-height).tickFormat("")),svg.append("g").attr("class","grid").call(plot.makeYGridlines().tickSize(-width).tickFormat(""))},draw:function(a,b){1==filter.movingDisplay&&svg.append("path").data([a]).attr("class","line "+b).attr("d",valueline),1==filter.pollsDisplay&&svg.selectAll("dot").data(a).enter().append("circle").attr("r",1).attr("cx",function(a){return x(a.date)}).attr("cy",function(a){return y(a.percentage)}).attr("class",b).append("svg:title").text(function(a){return a.company+" "+a.date.getDate()+"/"+(a.date.getMonth()+1)+"/"+a.date.getFullYear()+" : "+a.percentage+"%"}),1==filter.modelDisplay&&svg.append("path").data([modelDataDisplay[b]]).attr("class","modelline "+b).attr("d",modelline).style("stroke-dasharray","10, 5")},makeXGridlines:function(){return d3.axisBottom(x).ticks(5)},makeYGridlines:function(){return d3.axisLeft(y).ticks(10)},drawAxes:function(){var a=filter.datestart,b=filter.dateend,c=Math.floor((b-a)/2628e6);c>25&&(c=25),svg.append("g").attr("transform","translate(0,"+height+")").call(d3.axisBottom(x).ticks(c).tickFormat(timeFormat)).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform","rotate(-45)"),svg.append("g").call(d3.axisLeft(y)),svg.append("g").call(d3.axisRight(y2).ticks(15)).attr("transform","translate("+width+" , 0)"),svg.append("text").attr("transform","translate("+width/2+" ,"+(height+margin.top+30)+")").style("text-anchor","middle").text("Date"),svg.append("text").attr("transform","rotate(-90)").attr("y",0-margin.left).attr("x",0-height/2).attr("dy","1em").style("text-anchor","middle").text("Percentage"),svg.append("text").attr("transform","rotate(90)").attr("y",-width-margin.right).attr("x",0+height/2).attr("dy","1em").style("text-anchor","middle").text("Seats"),1==filter.modelDisplay&&svg.append("path").data([[{date:a,seats:326},{date:b,seats:326}]]).attr("class","majorityline").attr("d",majorityline).style("stroke-dasharray","2, 2")}},margin={top:20,right:40,bottom:60,left:40},width=1e3-margin.left-margin.right,height=800-margin.top-margin.bottom,parseTime=d3.timeParse("%d-%b-%y"),x=d3.scaleTime().range([0,width]),y=d3.scaleLinear().range([height,0]),y2=d3.scaleLinear().range([height,0]),timeFormat=d3.timeFormat("%b %y"),valueline=d3.line().x(function(a){return x(a.date)}).y(function(a){return y(a.moving)}),modelline=d3.line().x(function(a){return x(a.date)}).y(function(a){return y2(a.seats)}),majorityline=d3.line().x(function(a){return x(a.date)}).y(function(a){return y2(a.seats)}),pollData={labour:[],conservative:[],libdems:[],snp:[],green:[],ukip:[],others:[]},modelData={labour:[],conservative:[],libdems:[],snp:[],green:[],ukip:[],others:[]},modelDataDisplay={},companies=[];$(document).ready(function(){getData()});