<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronos: The Daily History Guess</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚åõ</text></svg>">
    <style>
        :root { --bg-color: #f8f9fa; --card-bg: #ffffff; --primary-text: #2c3e50; }
        body { background-color: var(--bg-color); color: var(--primary-text); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .game-container { max-width: 700px; margin: 40px auto; }
        .event-card { background: var(--card-bg); border-left: 5px solid #34495e; padding: 15px; margin-bottom: 12px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .guess-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 20px; margin-top: 8px; border-radius: 6px; color: white; font-weight: bold; }
        .stats-badge { font-size: 0.9rem; background: #e9ecef; padding: 5px 12px; border-radius: 20px; }
        .hidden { display: none; }
        .nav-tabs .nav-link { color: #495057; }
        .nav-tabs .nav-link.active { font-weight: bold; }
        #result-view .btn {
            min-width: 160px; /* Forces buttons to have a uniform minimum size */
        }
    </style>
</head>
<body>

<div class="container game-container">
    <header class="text-center mb-4">
        <h1 class="display-5 fw-bold">‚åõ Chronos</h1>
        <div class="d-flex justify-content-center gap-2 mt-2">
            <span id="mode-badge" class="stats-badge">Daily Mode</span>
            <span class="stats-badge">Attempts: <span id="attempts-left">8</span>/8</span>
        </div>
    </header>

    <div id="game-view">
        <div id="facts-area"></div>
        <div class="card p-4 mt-4 shadow-sm">
            <div class="input-group">
                <input type="number" id="guessYear" class="form-control form-control-lg" placeholder="Year">
                <select id="guessEra" class="form-select form-select-lg" style="max-width: 100px;">
                    <option value="AD">AD</option>
                    <option value="BC">BC</option>
                </select>
                <button class="btn btn-primary btn-lg" onclick="handleGuess()">Guess</button>
            </div>
        </div>
        <div id="feedback-list" class="mt-4"></div>
    </div>

    <div id="result-view" class="hidden text-center p-5 card shadow mt-4">
        <h2 id="result-title" class="mb-3"></h2>
        <p id="result-text" class="lead mb-4"></p>
        
        <div class="d-flex flex-wrap justify-content-center gap-3">
            <button id="btn-next" class="btn btn-success btn-lg" onclick="playAgain()">
                Play Again
            </button>
            <button class="btn btn-primary btn-lg" onclick="shareResult()">
                Share Result üìã
            </button>
            <button class="btn btn-outline-secondary btn-lg" onclick="toggleHistory()">
                History
            </button>
        </div>
    </div>

    <footer class="mt-5 text-center border-top pt-3">
        <div class="btn-group">
            <a href="?" class="btn btn-sm btn-outline-primary">Daily Mode</a>
            <a href="?mode=infinite" class="btn btn-sm btn-outline-secondary">Infinite Mode</a>
            <button class="btn btn-sm btn-outline-dark" onclick="toggleHistory()">My History</button>
        </div>
    </footer>
</div>

<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header"><h5>History & Stats</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="history-content"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let allChallenges = [];
    let currentChallenge = null;
    let attempts = 8;
    let isGameOver = false;
    let mode = 'daily';
    let currentSeed = null;
    let guessHistory = [];
    let won = false;
    let currentStreak = 0; // New global for streaks

    async function init() {
    try {
        const response = await fetch('challenges.json');
        if (!response.ok) throw new Error("File not found");
        allChallenges = await response.json();
        
        const params = new URLSearchParams(window.location.search);
        mode = params.get('mode') === 'infinite' ? 'infinite' : 'daily';
        
        if (mode === 'daily') {
            currentSeed = new Date().toDateString();
            // ALWAYS setup the challenge so currentChallenge is not null for sharing
            const hash = Array.from(currentSeed).reduce((s, c) => Math.imul(31, s) + c.charCodeAt(0) | 0, 0);
            currentChallenge = allChallenges[Math.abs(hash) % allChallenges.length];
            
            if (localStorage.getItem('chronos_daily_done') === currentSeed) {
                showAlreadyPlayed();
                return;
            }
        }
        setupGame();
    } catch (e) {
        document.getElementById('facts-area').innerHTML = `<div class="alert alert-danger">Error loading data.</div>`;
    }
    }

    function showAlreadyPlayed() {
        document.getElementById('game-view').classList.add('hidden');
        document.getElementById('result-view').classList.remove('hidden');
        document.getElementById('result-title').innerText = "Daily Complete!";
        // Add the timer display here
        document.getElementById('result-text').innerHTML = `
            <div class="mb-3">You've already played today's challenge.</div>
            <div class="small text-muted">Next Daily Challenge in:</div>
            <div id="timer" class="fw-bold fs-3 text-primary">00:00:00</div>
        `;
        document.getElementById('btn-next').classList.add('hidden');
        startTimer();
    }

    // --- Countdown Timer Logic ---
    function startTimer() {
        updateTimer();
        setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        const timerEl = document.getElementById('timer');
        if (!timerEl) return;

        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0);

        const diff = tomorrow - now;
        
        const hours = Math.floor(diff / (1000 * 60 * 60)).toString().padStart(2, '0');
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60)).toString().padStart(2, '0');
        const secs = Math.floor((diff % (1000 * 60)) / 1000).toString().padStart(2, '0');

        timerEl.innerText = `${hours}:${mins}:${secs}`;
    }

    function setupGame() {
        if (mode === 'daily') {
            const hash = Array.from(currentSeed).reduce((s, c) => Math.imul(31, s) + c.charCodeAt(0) | 0, 0);
            currentChallenge = allChallenges[Math.abs(hash) % allChallenges.length];
        } else {
            currentChallenge = allChallenges[Math.floor(Math.random() * allChallenges.length)];
            document.getElementById('mode-badge').innerText = "Infinite Mode";
        }
        renderFacts();
    }

    let visibleFacts = 1; // Start with one fact

    function renderFacts() {
        const factsArea = document.getElementById('facts-area');
        factsArea.innerHTML = `<p class="text-muted">Target is a <b>${currentChallenge.t}</b>:</p>`;
        
        currentChallenge.f.forEach((fact, index) => {
            // Trim to first sentence in the browser
            const firstSentence = fact.split(/(?<=[.!?])\s+/)[0];
            
            const isHidden = index >= visibleFacts ? 'hidden' : '';
            factsArea.innerHTML += `
                <div class="event-card fact-item ${isHidden}" id="fact-${index}">
                    ${firstSentence}
                </div>`;
        });

        // Add Hint Button if there are more facts to show
        if (visibleFacts < currentChallenge.f.length) {
            factsArea.innerHTML += `
                <button id="hint-btn" class="btn btn-sm btn-outline-info mt-2" onclick="showHint()">
                    üí° Reveal another clue
                </button>`;
        }
    }

    function showHint() {
        const nextFact = document.getElementById(`fact-${visibleFacts}`);
        if (nextFact) {
            nextFact.classList.remove('hidden');
            visibleFacts++;
        }
        // Remove button if no more facts
        if (visibleFacts >= currentChallenge.f.length) {
            document.getElementById('hint-btn')?.remove();
        }
    }

    function handleGuess() {
        if (isGameOver) return;
        const gYear = parseInt(document.getElementById('guessYear').value);
        const gEra = document.getElementById('guessEra').value;
        if (isNaN(gYear)) return;

        const tVal = currentChallenge.e === 'BC' ? -currentChallenge.y : currentChallenge.y;
        const gVal = gEra === 'BC' ? -gYear : gYear;
        let diff = Math.abs(tVal - gVal);
        if ((tVal < 0 && gVal > 0) || (tVal > 0 && gVal < 0)) diff -= 1;

        // Set the global 'won' variable
        won = (currentChallenge.t === 'year' && diff === 0) ||
            (currentChallenge.t === 'decade' && diff < 10 && Math.floor(Math.abs(tVal)/10) === Math.floor(Math.abs(gVal)/10)) ||
            (currentChallenge.t === 'century' && diff < 100 && Math.ceil(Math.abs(tVal)/100) === Math.ceil(Math.abs(gVal)/100) && currentChallenge.e === gEra);

        const config = getFeedbackConfig(diff, won);
        guessHistory.push(config.emoji);
        addFeedbackUI(gYear, gEra, config);

        if (won) endGame(true);
        else {
            attempts--;
            document.getElementById('attempts-left').innerText = attempts;
            if (attempts <= 0) endGame(false);
        }
    }

    function getFeedbackConfig(diff, won) {
        if (won) return { label: "CORRECT!", color: "#198754", emoji: "üü©" };
        if (diff <= 2) return { label: "1-2 yrs (Burning!)", color: "#dc3545", emoji: "üü•" };
        if (diff <= 10) return { label: "3-10 yrs (Hot)", color: "#fd7e14", emoji: "üüß" };
        if (diff <= 40) return { label: "11-40 yrs (Warm)", color: "#ffc107", emoji: "üü®" };
        if (diff <= 200) return { label: "41-200 yrs (Cool)", color: "#0dcaf0", emoji: "üü¶" };
        if (diff <= 1000) return { label: "200-1000 yrs (Cold)", color: "#0d6efd", emoji: "‚ùÑÔ∏è" };
        return { label: "Freezing (>1000 yrs)", color: "#4b0082", emoji: "üíÄ" };
    }

    function addFeedbackUI(year, era, cfg) {
        const row = document.createElement('div');
        row.className = 'guess-row';
        row.style.backgroundColor = cfg.color;
        row.innerHTML = `<span>${year} ${era}</span> <span>${cfg.label}</span>`;
        document.getElementById('feedback-list').prepend(row);
    }

    function endGame(winStatus) {
        isGameOver = true;
        won = winStatus; // Ensure global won is set
        document.getElementById('game-view').classList.add('hidden');
        document.getElementById('result-view').classList.remove('hidden');
        
        document.getElementById('result-title').innerText = won ? "üèÜ Victory!" : "‚åõ Time's Up!";
        document.getElementById('result-text').innerHTML = `The year was <b>${currentChallenge.y} ${currentChallenge.e}</b>.`;
        const history = JSON.parse(localStorage.getItem('chronos_history_v3') || '[]');
        calculateStreak(history);
        
        document.getElementById('result-text').innerHTML += `
            <div class="mt-2 small">Current Streak: <b>${currentStreak}</b> üî•</div>
        `;
        if (mode === 'daily') {
            localStorage.setItem('chronos_daily_done', currentSeed);
            const dailyResult = { 
                won: won, 
                score: guessHistory.length, // Use length here
                emojis: guessHistory 
            };
            localStorage.setItem('chronos_daily_result', JSON.stringify(dailyResult));
        }
        saveHistory(won);
        if (mode === 'daily') startTimer();
    }

    function saveHistory(wonStatus) {
        const history = JSON.parse(localStorage.getItem('chronos_history_v3') || '[]');
        history.push({ 
            d: new Date().toLocaleDateString(), // Consistent date format
            y: `${currentChallenge.y} ${currentChallenge.e}`, 
            w: wonStatus, 
            s: guessHistory.length,
            m: mode 
        });
        localStorage.setItem('chronos_history_v3', JSON.stringify(history));
    }

    function shareResult() {
        let finalWon = won;
        let emojis = guessHistory.join('');
        let finalScore = guessHistory.length; // Change this line

        if (mode === 'daily' && guessHistory.length === 0) {
            const saved = JSON.parse(localStorage.getItem('chronos_daily_result'));
            if (saved) {
                finalWon = saved.won;
                finalScore = saved.score;
                emojis = saved.emojis.join('');
            }
        }

    const scoreDisplay = finalWon ? finalScore : "X";
    // ... rest of the function remains the same ...
        const text = `‚åõ Chronos ${mode === 'daily' ? 'Daily' : 'Infinite'}\n` +
                    `Year: ${currentChallenge.y} ${currentChallenge.e}\n` +
                    `${emojis}\n` +
                    `Result: ${scoreDisplay}/8\n` +
                    window.location.href;

        navigator.clipboard.writeText(text).then(() => {
            alert("Result copied to clipboard!");
        });
    }

    // Update your toggleHistory function's modal footer or top
    function toggleHistory() {
        const history = JSON.parse(localStorage.getItem('chronos_history_v3') || '[]');
        calculateStreak(history); 

        const dailyGames = history.filter(g => g.m === 'daily');
        const infiniteGames = history.filter(g => g.m === 'infinite');

        const statsHeader = `
            <div class="row text-center mb-4">
                <div class="col">
                    <div class="small text-muted text-uppercase">Daily</div>
                    <div class="h4 mb-0">${dailyGames.length} Played</div>
                    <div class="fw-bold text-primary">${currentStreak} Day Streak üî•</div>
                </div>
                <div class="col border-start">
                    <div class="small text-muted text-uppercase">Infinite</div>
                    <div class="h4 mb-0">${infiniteGames.length} Played</div>
                    <div class="text-success">${infiniteGames.filter(g => g.w).length} Wins ‚úÖ</div>
                </div>
            </div>
        `;

        const tableHtml = `
            <ul class="nav nav-tabs" id="historyTabs">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#h-daily">Daily</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#h-inf">Infinite</button></li>
            </ul>
            <div class="tab-content pt-3" style="max-height: 400px; overflow-y: auto;">
                <div class="tab-pane fade show active" id="h-daily">${generateTable(dailyGames.reverse())}</div>
                <div class="tab-pane fade" id="h-inf">${generateTable(infiniteGames.reverse())}</div>
            </div>
        `;

        const clearBtn = `<div class="mt-4 pt-3 border-top text-center">
            <button class="btn btn-sm btn-outline-danger" onclick="clearAllData()">Clear All Game Data</button>
        </div>`;

        document.getElementById('history-content').innerHTML = statsHeader + tableHtml + clearBtn;
        new bootstrap.Modal(document.getElementById('historyModal')).show();
    }

    function generateTable(data) {
        if (!data || data.length === 0) return "<p class='text-center p-3 text-muted'>No games played yet.</p>";
        let t = '<table class="table table-hover align-middle"><thead><tr><th>Date</th><th>Year</th><th>Result</th></tr></thead><tbody>';
        data.forEach(g => {
            // 's' now correctly reflects guessHistory.length
            const resultText = g.w ? `${g.s} ${g.s === 1 ? 'guess' : 'guesses'}` : 'Failed';
            t += `<tr>
                    <td>${g.d}</td>
                    <td><span class="badge bg-secondary">${g.y}</span></td>
                    <td>${g.w ? '‚úÖ' : '‚ùå'} ${resultText}</td>
                </tr>`;
        });
        return t + '</tbody></table>';
    }

    function calculateStreak(history) {
        const dailyWins = history.filter(g => g.m === 'daily' && g.w === true);
        if (!dailyWins.length) {
            currentStreak = 0;
            return;
        }

        // Sort by date descending (Newest first)
        dailyWins.sort((a, b) => new Date(b.d) - new Date(a.d));

        let streak = 0;
        let checkDate = new Date(); // Start from today
        checkDate.setHours(0,0,0,0);

        for (let game of dailyWins) {
            let gameDate = new Date(game.d);
            gameDate.setHours(0,0,0,0);
            
            const diffTime = checkDate - gameDate;
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1); // Move check back to yesterday
            } else if (diffDays === 1) {
                // This handles the case where the first game checked is "yesterday" 
                // because they haven't won "today" yet
                streak++;
                checkDate = gameDate;
                checkDate.setDate(checkDate.getDate() - 1);
            } else {
                break; 
            }
        }
        currentStreak = streak;
    }

    function clearAllData() {
        if (confirm("Are you sure? This will delete ALL history, streaks, and today's result!")) {
            // Clear all known keys
            const keys = [
                'chronos_history_v2', 
                'chronos_history_v3', 
                'chronos_daily_done', 
                'chronos_daily_result'
            ];
            keys.forEach(k => localStorage.removeItem(k));
            
            alert("All data cleared.");
            // Redirect to Daily mode to start fresh
            window.location.href = window.location.pathname; 
        }
    }
    
    function playAgain() {
        // If we are in Daily mode and finished, 'Play Again' should take us to Infinite
        if (mode === 'daily') {
            window.location.href = "?mode=infinite";
        } else {
            // If already in Infinite mode, just reset the game state and pick a new year
            resetGameState();
        }
    }

    function resetGameState() {
        // Reset variables
        attempts = 8;
        isGameOver = false;
        guessHistory = [];
        won = false;
        visibleFacts = 1;

        // Reset UI
        document.getElementById('attempts-left').innerText = attempts;
        document.getElementById('feedback-list').innerHTML = '';
        document.getElementById('game-view').classList.remove('hidden');
        document.getElementById('result-view').classList.add('hidden');
        document.getElementById('guessYear').value = '';

        // Pick a new challenge
        setupGame();
    }

    init();
</script>
</body>
</html>